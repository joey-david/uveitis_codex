- 2026-02-05T23:36:17+01:00 Cleaned eval/: kept eval/triptych.png + eval/sam2_fundus_qa_uveitis10; moved other eval outputs to /tmp/eval_archive_20260205_233604
- 2026-02-05T23:53:44+01:00 Built UWF700 Uveitis(100) label stage: preprocessed 100 images (SAM2 ROI + color norm -> preproc/global_1024 + tiles), generated COCO labels in labels_coco/ and overlays in labels_debug/, and wrote 4 raw-vs-postproc preview composites + montage at eval/uwf700_uveitis_label_transfer_previews/montage_2x2.png
- 2026-02-06T01:36:53+01:00 Created commits and ran training: set up RETFound (vendor + weights), preprocessed FGADR (1842), rebuilt COCO labels (FGADR+UWF), trained runs fgadr_vitl_1h and uveitis_from_fgadr_vitl_1h with curves in runs/*/curves.png, generated inference previews in preds_vis/uveitis_from_fgadr_vitl_1h_preview

- 2026-02-06T12:30:15+01:00 diagnostics: added real AP evaluator, compared RETFound vs R50 on FGADR (small objects), tried RetinaNet (failed), added notes/model_diagnostics.md
- 2026-02-06T14:39:00+01:00 label-space: wrote down reduced-class policy (FGADR-present + top-6 UWF, vascularite separate) in configs/active_label_space.yaml + configs/main_detector_classes.txt + docs/structure/label_space.md; started main detector training with UWF oversampling to reduce domain dominance.
- 2026-02-06T17:33:16+01:00 cleanup: pruned eval/ to (triptych + sam2 QA), removed old runs/obb checkpoints, removed preproc intermediates (crops/tiles), preserved best weights in out/weights
- 2026-02-06T21:40:01+01:00 docs: updated mkdocs + docker runbook for YOLOv8-OBB tooling, label-space policy, and vascularite module; added script/API doc pages; referenced bundled contrastive paper
- 2026-02-23T17:35:00+01:00 mask-transfer pass: committed snapshot, added precise FGADR mask->OBB + tile polygon clipping, rebuilt UWF100 high-res + FGADR subset datasets, ran E1/E2/E3 sweeps; best is MT_E1 (mAP50-95=0.1276 tuned eval) with previews in eval/yolo_obb_previews_masktransfer/
- Swept inference imgsz (768..2048) for current best mmproxy checkpoint on uwf100_hr3072 val; best was 1024 (mAP50=0.1834, mAP50-95=0.0982), 768 was slightly lower, >=1280 degraded sharply. Logged to eval/diagnostics/main9_mmproxy_imgsz_sweep_2026-02-24.json.
- Kept work at imgsz=1024 and upgraded RETFound rerank pipeline: added class-wise polygon NMS after prediction aggregation, optional multi-scale inference list, and optional crop normalization modes (none/clahe/reinhard/reinhard+clahe with FGADR reference stats).
- Ran 4 sweeps on uwf100_hr3072_main9_precise val: single1024, single1024+align, single1024+clahe, and multiscale 896/1024/1152. Best is single1024 with quantile=0.1/conf=0.001 at mAP50=0.10295, mAP50-95=0.05003; previews saved under eval/retfound_rerank_uwf100_1024_single/best_previews.
- Added RETFound domain-gap diagnostics script and ran FGADR vs UWF gap studies (raw, reinhard, clahe, reinhard+clahe). Logged outputs in eval/diagnostics/retfound_domain_gap_*.json and summary in eval/diagnostics/retfound_rerank_1024_summary_2026-02-24.json.
- Built a RETFound-aligned YOLO dataset variant (`out/yolo_obb/uwf100_hr3072_main9_precise_retfalign`) by applying reinhard-to-FGADR+CLAHE only on non-black ROI pixels; labels are preserved.
- Trained/evaluated aligned fine-tune `RETFALIGN_E1_1024_e12` (imgsz=1024). On aligned val: mAP50-95=0.09132; on original val with this checkpoint: mAP50-95=0.08119.
- Measured that full-image alignment did not beat the current best original-domain checkpoint on original val (0.09817). Saved summary at `eval/diagnostics/retfound_align_training_summary_2026-02-24.json`.
- Added side-by-side prediction previews (orig checkpoint vs aligned fine-tune) at `eval/retfound_align_compare_previews`.
- Generated 8 qualitative prediction panels for the current best checkpoint at 1024 (`out/weights/yolo_obb_main9_mmproxy_contrastive_best.pt`) on UWF val tiles; each panel shows raw / preds / GT+pred overlay in `eval/current_best_preds_2026-02-24`.
- Fixed qualitative preview issue: previous random samples were mostly background tiles (no GT). Regenerated previews with positive-GT tiles only (`eval/current_best_preds_positive_tiles_2026-02-25`) and added non-tiled full-image panels (`eval/current_best_preds_full_2026-02-25`) with GT(red)+pred(green).
- Added/updated `notes/NEW_IMPLEMENTATION_ROADMAP.md` with concise scratch rebuild plan.
- Massive repo cleanup done: removed heavy generated folders (`runs/`, `eval/`, `out/`, `third_party/`) and non-essential tooling/docs.
- Kept focused canvas: datasets, stage-0 dataset utilities, minimal pipeline modules, and `models/retfound/RETFound_cfp_weights.pth`.
- Updated `notes/NEW_IMPLEMENTATION_ROADMAP.md` header with explicit instruction to keep step-by-step implementation notes (actions, blockers, fixes, progress), including across context compactions.
- Expanded `notes/NEW_IMPLEMENTATION_ROADMAP.md` with concise context: objective, tool stack (SAM2/ROI normalization/RETFound/mask->OBB), and key past failure modes to avoid.
- Replaced COCO-centric label build with native fine-grained polygon pipeline (`src/uveitis_pipeline/labels_native.py` + rewired `scripts/stage0_build_labels.py`) and class-space filtering from `configs/active_label_space.yaml`.
- Added native pipeline stages for RETFound mask-first training: dataset/model modules (`native_dataset.py`, `retfound_mask.py`) and scripts `stage4_adapt_retfound.py`, `stage5_train_mask_head.py`, `stage6_infer_mask_to_obb.py`, `stage7_calibrate_thresholds.py`.
- Added QA/reporting support (`scripts/qa_native_labels.py`, `src/uveitis_pipeline/reports.py`) and updated configs for stage4-7 + main/vascularite native label exports.
- Ran dockerized smoke checks end-to-end (stage0 manifest/preprocess/native-label build/QA + stage4-7), fixed adaptation->train pos-embed mismatch via `load_encoder_state` interpolation.
- Added `notes/NATIVE_PIPELINE_RUNBOOK.md` with stage-by-stage commands, expected artifacts, and native (non-COCO) workflow outputs.
- Iteration kickoff: enabled reliable docker GPU path (`--runtime=nvidia --gpus all`), added SAM2.1 config+checkpoint, built fast manifests + `uwf700_labeled` manifest (98 images), computed regular-fundus color reference (150 sampled images), and started full `preproc_main9_fastiter` preprocessing for the first training loop.
- Completed multi-run optimization loop (iterB/C/D/E) with native eval + calibration sweeps; best is iterC + capped postprocess (`max_preds_per_class=2`) at `map50=0.1073`, `macro_f1=0.0559` on UWF val; outputs in `eval/main9_best_preds_v2` and report in `notes/ITERATION_REPORT_2026-02-25.md`.
- Trained/adapted iterA->iterE experiments and diagnosed major failure mode (sparse-positive class collapse); updated loss and calibration behavior accordingly.
- Best run is `runs/retfound_mask/main9_iterC/best.pt`; best inference config is `configs/experiments/main9_best_infer.yaml` with per-class calibration + `max_preds_per_class=2`.
- Current best native val metrics: `map50=0.1073`, `macro_f1=0.0559` in `eval/main9_best_preds_v2/metrics_ap50_v2.json`.
- Storage cleanup: removed non-best heavy checkpoints (iterA/B/D/E and `last.pt` files), kept only adaptation best + iterC best.
- 2026-02-25T23:03:00+01:00 Added detection-level postprocess calibration + stage6 classwise override support; improved iterC AP from 0.1073 to 0.1239 (eval/main9_iterC_detcalib_preds).
- 2026-02-25T23:03:00+01:00 Added stage6 TTA + union-component mode and ran sweeps; neither beat per-class mode on AP.
- 2026-02-25T23:03:00+01:00 Ran iterG/iterJ retraining ablations with new sampler/class-weight controls; iterG underperformed, iterJ had high unweighted AP but class collapse.
- 2026-02-25T23:03:00+01:00 Built class-wise ensemble (iterC + iterJ for oedeme only), saved best outputs in eval/main9_ensemble_best_preds with map50=0.2739.
- 2026-02-25T23:07:00+01:00 Added reusable scripts for class-wise ensemble (`scripts/ensemble_native_predictions.py`) and overlay QA (`scripts/qa_native_pred_overlays.py`); reproduced best ensemble outputs + previews in `eval/main9_ensemble_best_preds`.
- 2026-02-25T23:18:00+01:00 Froze best checkpoint `main9_ensemble_ap02739`: saved manifest + calibration/choice snapshots in `checkpoints/main9_ensemble_ap02739` and added detailed performance/limitations report in `notes/CHECKPOINT_main9_ensemble_ap02739.md`.
